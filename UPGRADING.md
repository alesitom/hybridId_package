# Upgrading

## From v3.x to v4.0.0

### `requireExplicitNode` defaults to `true`

Production instances now require an explicit node to prevent accidental collisions.

```php
// v3: worked silently with auto-detected node
$gen = new HybridIdGenerator();

// v4: throws NodeRequiredException
$gen = new HybridIdGenerator();

// v4: fix — provide explicit node
$gen = new HybridIdGenerator(node: 'A1');

// v4: or disable the guard for local dev
$gen = new HybridIdGenerator(requireExplicitNode: false);
```

### Compact profile drops node field

Compact changed from `8ts + 2node + 6rand` (35.7 bits entropy) to `8ts + 8rand` (47.6 bits entropy). Length stays 16.

If you relied on `extractNode()` for compact IDs, it now returns `null`.

### `IdGenerator` interface requires `generateBatch()`

If you implemented `IdGenerator` directly, add:

```php
public function generateBatch(int $count, ?string $prefix = null): array;
```

### `toUUIDv4()` / `fromUUIDv4()` renamed

```php
// v3
UuidConverter::toUUIDv4($id);
UuidConverter::fromUUIDv4($uuid);

// v4
UuidConverter::toUUIDv4Format($id);
UuidConverter::fromUUIDv4Format($uuid);
```

### Node auto-detection changed

Auto-detected nodes now use `random_bytes(2)` instead of `crc32(hostname:pid)`. This is more collision-resistant in containerized environments but non-deterministic. Production should always set explicit nodes.

### `registerProfile()` / `resetProfiles()` deprecated

These mutate global static state and are unsafe in long-lived processes. Migrate to `ProfileRegistry` injection:

```php
// v3
HybridIdGenerator::registerProfile('medium', 12);

// v4
$registry = ProfileRegistry::withDefaults();
$registry->register('medium', 12);
$gen = new HybridIdGenerator(profile: 'medium', node: 'A1', registry: $registry);
```

### Exception changes

- Constructor node validation throws `InvalidIdException` instead of `\InvalidArgumentException`
- New exceptions: `NodeRequiredException`, `IdOverflowException`, `InvalidPrefixException`, `InvalidProfileException`
- All implement `HybridIdException` marker interface
- Batch limit reduced from 100,000 to 10,000

## From v2.x to v3.0.0

### `IdGenerator` interface expanded

`bodyLength()` and `validate()` promoted to the interface. If you implemented `IdGenerator` directly, add both methods.

### CLI refactored

`bin/hybrid-id` refactored to `HybridId\Cli\Application`. Exit codes fixed (errors now return 1 instead of 0).

## From v1.x to v2.0.0

### Static class replaced with instances

```php
// v1
$id = HybridId::generate('standard', 'A1');

// v2+
$gen = new HybridIdGenerator(profile: 'standard', node: 'A1');
$id = $gen->generate();
```

### New features in v2

- Stripe-style prefix support
- `compare()` for chronological sorting
- Custom profile registration
- Profile-specific methods (`compact()`, `standard()`, `extended()`)

## ID Format Compatibility

IDs generated by any version are structurally compatible — same base62 alphabet, same lengths. The format itself has not changed across versions. Only the API for generating and inspecting IDs has evolved.
